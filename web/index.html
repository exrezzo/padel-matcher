<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Padel Match Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { color-scheme: light dark; --bg:#0b0c10; --fg:#e5e7eb; --card:#111827; --muted:#9ca3af; }
      html, body { height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0c10; color:var(--fg); }
      .wrap { min-height:100%; display:grid; place-items:center; padding:24px; }
      .card { width:100%; max-width:900px; background: rgba(17,24,39,.9); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:24px; }
      h1 { margin:0 0 12px 0; font-size:24px; }
      h2 { margin:16px 0 8px; font-size:18px; }
      p { margin:0 0 12px 0; color:var(--muted); }
      .grid { display:grid; grid-template-columns: 140px 1fr; gap:6px 12px; }
      .label { color:var(--muted); }
      code { background: rgba(255,255,255,.06); padding:2px 6px; border-radius:6px; }
      ul { margin:8px 0 0 0; padding-left:18px; }
      li { margin:8px 0; }
      form.inline { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
      input, select, textarea { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.05); color:var(--fg); }
      textarea { width:100%; min-height:60px; resize: vertical; }
      button { padding:8px 12px; border-radius:8px; background:#2563eb; color:white; border:none; cursor:pointer; }
      button:disabled { opacity:.6; cursor:not-allowed; }
      .muted { color:var(--muted); }
      a { color:#93c5fd; }
      .row { display:flex; gap:10px; align-items:center; }
      .sep { opacity:.35; }
      .error { color: #fecaca; }
      .warn { color: #fde68a; }
      .note-status { font-size:12px; color:var(--muted); }
      .p-inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      .p-inline > * { flex: 0 0 auto; }
      .p-notes-input { flex: 1 1 100%; }
      /* New layout for participant item */
      .p-row { display:flex; gap:12px; align-items:flex-start; }
      .p-left { flex: 1 1 auto; display:flex; gap:10px; align-items:center; }
      .p-right { flex: 0 0 280px; display:flex; gap:8px; align-items:flex-start; }
      .p-notes-small { width: 200px; height: 48px; resize: vertical; min-height: 40px; }
      .status { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid transparent; text-transform: lowercase; }
      .s-invited { background:#f59e0b1a; color:#fbbf24; border-color:#f59e0b55; }
      .s-confirmed { background:#10b9811a; color:#34d399; border-color:#10b98155; }
      .s-declined { background:#ef44441a; color:#f87171; border-color:#ef444455; }
      .s-not_invited { background:#6b72801a; color:#9ca3af; border-color:#6b728055; }
      .status-select { padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color:var(--fg); }
      /* Counter badge styles */
      .count { margin: 4px 0 8px 0; }
      .count-badge { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid transparent; margin-left:6px; }
      .c-need { background:#f59e0b1a; color:#fbbf24; border-color:#f59e0b55; }
      .c-full { background:#10b9811a; color:#34d399; border-color:#10b98155; }
      .c-over { background:#6366f11a; color:#a5b4fc; border-color:#6366f155; }

      /* Share styles */
      .share { display:flex; gap:8px; align-items:center; margin: 4px 0 12px 0; }
      .wa-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:50%; background:#25D366; color:#fff; text-decoration:none; box-shadow: 0 2px 6px rgba(0,0,0,.2); }
      .wa-btn:hover { filter: brightness(1.05); }
      .wa-btn svg { width:20px; height:20px; fill: currentColor; }

      /* Status group separator */
      .status-group-separator {
        margin: 16px 0 12px 0;
        padding: 8px 12px;
        background: rgba(255,255,255,.03);
        border-left: 3px solid rgba(255,255,255,.2);
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .status-group-separator.confirmed { border-left-color: #34d399; }
      .status-group-separator.invited { border-left-color: #fbbf24; }
      .status-group-separator.not_invited { border-left-color: #9ca3af; }
      .status-group-separator.declined { border-left-color: #f87171; }

      /* Add note button */
      .add-note-btn {
        padding: 4px 10px;
        font-size: 12px;
        background: rgba(255,255,255,.08);
        border: 1px solid rgba(255,255,255,.12);
        border-radius: 6px;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.2s;
      }
      .add-note-btn:hover {
        background: rgba(255,255,255,.12);
        color: var(--fg);
      }
      .notes-section {
        display: none;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(255,255,255,.08);
      }
      .notes-section.visible {
        display: flex;
        gap: 8px;
        align-items: flex-start;
      }

      /* Responsive adjustments */
      @media (max-width: 640px) {
        .wrap { padding: 12px; }
        .card { padding: 16px; }
        h1 { font-size: 20px; }
        h2 { font-size: 16px; }
        .grid { grid-template-columns: 1fr; }
        .p-row { flex-direction: column; gap: 8px; }
        .p-left { flex-wrap: wrap; gap: 6px; align-items: center; }
        .p-right {
          flex: 1 1 auto;
          width: 100%;
        }
        .p-right .add-note-btn {
          display: none; /* Hide the button in p-right on mobile */
        }
        .add-note-btn-mobile {
          display: inline-block !important; /* Show mobile version */
        }
        .p-notes-small { width: 100%; height: 56px; }
        .status-select { font-size: 14px; }
        .notes-section {
          width: 100%;
          margin-top: 8px;
        }
        .notes-section.visible {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        input, select, textarea, button { font-size: 16px; }
      }

      /* Mobile-only add note button */
      .add-note-btn-mobile {
        display: none;
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="card" role="region" aria-labelledby="title">
        <h1 id="title">Padel match</h1>
        <p id="desc">Loadingâ€¦</p>
        <div class="share">
          <span class="muted">Share:</span>
          <a id="wa_share" class="wa-btn" href="#" target="_blank" rel="noopener" aria-label="Share on WhatsApp" title="Share on WhatsApp">
            <svg viewBox="0 0 32 32" aria-hidden="true">
              <path d="M19.11 17.22c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.6.14-.18.27-.69.88-.85 1.06-.16.18-.31.2-.58.07-.27-.14-1.15-.42-2.19-1.33-.81-.72-1.35-1.61-1.5-1.89-.16-.27-.02-.42.12-.56.12-.12.27-.31.4-.47.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.47-.07-.14-.6-1.45-.82-1.99-.22-.53-.45-.46-.6-.46-.16 0-.34-.02-.52-.02-.18 0-.47.07-.72.34-.25.27-.95.93-.95 2.26 0 1.33.98 2.61 1.12 2.79.14.18 1.93 2.95 4.67 4.14.65.28 1.16.45 1.55.58.65.21 1.25.18 1.72.11.52-.08 1.6-.65 1.82-1.28.22-.63.22-1.17.16-1.28-.05-.11-.22-.18-.49-.31zM16 3C9.38 3 4 8.38 4 15c0 2.65.9 5.1 2.4 7.06L5 29l7.13-1.34C14.02 28.55 15 28.66 16 28.66 22.62 28.66 28 23.28 28 16.66 28 10.04 22.62 4.66 16 4.66zm0 22.67c-.92 0-1.82-.16-2.65-.47l-.19-.07-4.32.82.82-4.2-.09-.2C8.22 20.61 7.33 18.38 7.33 16 7.33 10.99 11.66 6.66 16.67 6.66s9.33 4.33 9.33 9.34S21.01 25.67 16 25.67z"/>
            </svg>
          </a>
        </div>

        <div id="details" style="display:none">
          <div class="grid" aria-describedby="desc">
            <div class="label">Title</div>
            <div id="m_title" class="row"></div>
            <div class="label">Status</div>
            <div id="m_status"></div>
            <div class="label">Created</div>
            <div id="m_created"></div>
          </div>

          <h2>Match notes</h2>
          <div class="row" style="align-items:flex-start; gap:8px;">
            <textarea id="m_notes" style="flex:1; min-height:80px; width:100%;"></textarea>
            <div style="display:flex; flex-direction:column; gap:6px;">
              <button id="m_save">Save</button>
              <span id="m_notes_status" class="note-status"></span>
            </div>
          </div>

          <h2>Participants</h2>
          <div id="count" class="count"></div>
          <ul id="participants"></ul>
          <form id="p_form" class="inline" autocomplete="off">
            <div class="p-inline">
              <input id="p_name" name="name" placeholder="Participant name" required />
              <select id="p_status" name="status">
                <option value="not_invited" selected>not invited</option>
                <option value="invited">invited</option>
                <option value="confirmed">confirmed</option>
                <option value="declined">declined</option>
              </select>
              <button id="p_add" type="submit">Add</button>
            </div>
            <textarea id="p_notes" class="p-notes-input" name="notes" placeholder="Notes (optional)"></textarea>
          </form>
          <div id="p_msg" class="muted" aria-live="polite"></div>
        </div>

        <h2>Your matches</h2>
        <div id="my_matches" class="row" style="justify-content:space-between; align-items:center; gap:8px;">
          <ul id="my_matches_list" style="flex:1 1 auto; margin:0; padding-left:18px;"></ul>
          <button id="my_matches_clear" style="flex:0 0 auto;">Clear</button>
        </div>

        <p style="margin-top:16px"><a href="create.html">Create a new match</a></p>
      </section>
    </main>

    <script>
      (function () {
        const params = new URLSearchParams(location.search);
        const UUID = (params.get("id") || "").trim();

        const desc = document.getElementById("desc");
        const details = document.getElementById("details");
        const mTitle = document.getElementById("m_title");
        const mStatus = document.getElementById("m_status");
        const mCreated = document.getElementById("m_created");
        const list = document.getElementById("participants");
        const pForm = document.getElementById("p_form");
        const pName = document.getElementById("p_name");
        const pStatus = document.getElementById("p_status");
        const pNotes = document.getElementById("p_notes");
        const pMsg = document.getElementById("p_msg");
        const countEl = document.getElementById("count");
        const mNotes = document.getElementById("m_notes");
        const mSave = document.getElementById("m_save");
        const mNotesStatus = document.getElementById("m_notes_status");
        const waShare = document.getElementById("wa_share");
        const myMatchesList = document.getElementById("my_matches_list");
        const STORAGE_KEY = 'pm_my_matches_v1';
        const myMatchesClear = document.getElementById('my_matches_clear');

        if (!UUID) {
          desc.textContent = "Select a match from your list below or create a new one.";
          if (details) details.style.display = "none";
          if (waShare) waShare.style.display = "none";
          renderMyMatches(null);
          return;
        }

        const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
        const localBase = `${location.protocol}//${location.hostname}:54321`;
        const BASE = isLocal ? localBase : "https://epbxkcopfodxdseteqlh.functions.supabase.co";
        const anonKey = isLocal ? null : "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwYnhrY29wZm9keGRzZXRlcWxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODY0OTgsImV4cCI6MjA3Mzk2MjQ5OH0.JNifi9ckldkZi7eKJkCnPBtOPM1y5eLZTKJ19THY-YI";

        function buildHeaders() {
          const base = { "Content-Type": "application/json" };
          if (isLocal) return base;
          if (!anonKey) {
            const warn = document.createElement("div");
            warn.className = "warn";
            warn.textContent = "Missing anon key. Some actions may fail (401).";
            document.querySelector(".card").prepend(warn);
            return base;
          }
          return { ...base, apikey: anonKey, Authorization: `Bearer ${anonKey}` };
        }

        async function fetchMatch() {
          desc.textContent = "Loadingâ€¦";
          details.style.display = "none";
          try {
            const res = await fetch(`${BASE}/functions/v1/get-match?id=${encodeURIComponent(UUID)}`, {
              headers: buildHeaders(),
            });
            const json = await res.json();
            if (!res.ok || !json.ok) {
              desc.textContent = `Error: ${json.error || res.statusText}`;
              return;
            }
            render(json.match);
          } catch (e) {
            desc.textContent = `Request failed`;
          }
        }

        function getMyMatches() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            const arr = raw ? JSON.parse(raw) : [];
            return Array.isArray(arr) ? arr : [];
          } catch (_) { return []; }
        }
        function setMyMatches(arr) {
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr || [])); } catch (_) {}
        }
        function touchCurrent(id, title) {
          if (!id) return;
          const now = new Date().toISOString();
          const arr = getMyMatches();
          const map = new Map(arr.map(x => [x.id, x]));
          const prev = map.get(id) || {};
          map.set(id, { ...prev, id, title: title || prev.title || '', updatedAt: now, createdAt: prev.createdAt || now });
          setMyMatches(Array.from(map.values()));
        }
        function renderMyMatches(currentId) {
          if (!myMatchesList) return;
          const arr = getMyMatches()
            .slice()
            .sort((a, b) => String(b.updatedAt || '').localeCompare(String(a.updatedAt || '')));
          myMatchesList.innerHTML = '';
          if (arr.length === 0) {
            const li = document.createElement('li');
            li.className = 'muted';
            li.textContent = 'No saved matches yet';
            myMatchesList.appendChild(li);
            return;
          }
          const max = 10;
          for (const m of arr.slice(0, max)) {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = `index.html?id=${encodeURIComponent(m.id)}`;
            a.textContent = m.title || m.id;
            if (m.id === currentId) {
              a.style.fontWeight = '600';
            }
            li.appendChild(a);
            myMatchesList.appendChild(li);
          }
        }

        function render(match) {
          function friendlyStatus(v) { return v === 'not_invited' ? 'not invited' : v; }
          function statusClass(v) {
            if (v === 'confirmed') return 's-confirmed';
            if (v === 'declined') return 's-declined';
            if (v === 'invited') return 's-invited';
            return 's-not_invited';
          }

          // Status order priority for sorting
          function statusOrder(status) {
            const s = String(status || 'not_invited').toLowerCase();
            if (s === 'confirmed') return 0;
            if (s === 'invited') return 1;
            if (s === 'not_invited') return 2;
            if (s === 'declined') return 3;
            return 4; // fallback for unknown statuses
          }

          document.title = `Padel Match â€¢ ${match.title}`;
          desc.textContent = `Viewing match`;
          mTitle.textContent = match.title;
          mStatus.textContent = match.status;
          mCreated.textContent = new Date(match.created_at).toLocaleString();
          details.style.display = "block";
          if (mNotes) mNotes.value = match.notes || "";

          // Ensure current match is saved/touched locally and render list
          touchCurrent(match.id, match.title);
          renderMyMatches(match.id);

          // Build WhatsApp share link for this match
          if (waShare) {
            const pageUrl = window.location.href;
            const text = `Padel match: ${match.title}\n${pageUrl}`;
            waShare.href = `https://wa.me/?text=${encodeURIComponent(text)}`;
          }

          list.innerHTML = "";
          const participants = Array.isArray(match.match_participants) ? match.match_participants : [];

          // Sort participants by status: confirmed, invited, not_invited, declined
          const sortedParticipants = participants.slice().sort((a, b) => {
            const orderA = statusOrder(a.status);
            const orderB = statusOrder(b.status);
            if (orderA !== orderB) return orderA - orderB;
            // Secondary sort by name for participants with the same status
            return String(a.name || '').localeCompare(String(b.name || ''));
          });

          // Update counter (target 4)
          const TARGET = 4;
          const confirmedCount = participants.filter((p) => String(p.status || '').toLowerCase() === 'confirmed').length;
          const remaining = Math.max(0, TARGET - confirmedCount);
          let cls = confirmedCount === TARGET ? 'c-full' : (confirmedCount < TARGET ? 'c-need' : 'c-over');
          if (countEl) {
            countEl.innerHTML = `Confirmed: <span class="count-badge ${cls}">${confirmedCount}/${TARGET}</span> ${confirmedCount < TARGET ? `(${remaining} needed)` : confirmedCount > TARGET ? `(over by ${confirmedCount - TARGET})` : '(full)'}`;
          }

          if (sortedParticipants.length === 0) {
            const li = document.createElement("li");
            li.className = "muted";
            li.textContent = "No participants yet";
            list.appendChild(li);
          } else {
            let currentStatusGroup = null;

            for (const p of sortedParticipants) {
              const s = String(p.status || "not_invited").toLowerCase();

              // Add separator when entering a new status group
              if (currentStatusGroup !== s) {
                const separator = document.createElement("div");
                separator.className = `status-group-separator ${s}`;
                separator.textContent = friendlyStatus(s);
                list.appendChild(separator);
                currentStatusGroup = s;
              }

              // Build participant item container
              const li = document.createElement("li");
              li.style.listStyle = "none";

              const mainRow = document.createElement("div");
              mainRow.className = "p-row";

              const left = document.createElement("div");
              left.className = "p-left";
              const nameEl = document.createElement("strong");
              nameEl.textContent = p.name;
              const st = document.createElement("span");
              const sClass = statusClass(s);
              st.className = `status ${sClass}`;
              st.textContent = friendlyStatus(s);
              left.appendChild(nameEl);
              left.appendChild(st);

              // Editable status dropdown
              const statusSel = document.createElement("select");
              statusSel.className = "status-select";
              for (const opt of ["not_invited","invited","confirmed","declined"]) {
                const o = document.createElement("option");
                o.value = opt; o.textContent = friendlyStatus(opt); if (opt === s) o.selected = true; statusSel.appendChild(o);
              }
              statusSel.addEventListener("change", () => {
                const val = statusSel.value;
                st.className = `status ${statusClass(val)}`;
                st.textContent = friendlyStatus(val);
              });
              left.appendChild(statusSel);

              const right = document.createElement("div");
              right.className = "p-right";

              const hasNotes = (p.notes || "").trim().length > 0;

              // Mobile version of add note button (in left section)
              const addNoteBtnMobile = document.createElement("button");
              addNoteBtnMobile.textContent = hasNotes ? "Edit Note" : "Add Note";
              addNoteBtnMobile.className = "add-note-btn add-note-btn-mobile";
              addNoteBtnMobile.type = "button";
              left.appendChild(addNoteBtnMobile);

              // Add/Edit note button (desktop version in right section)
              const addNoteBtn = document.createElement("button");
              addNoteBtn.textContent = hasNotes ? "Edit Note" : "Add Note";
              addNoteBtn.className = "add-note-btn";
              addNoteBtn.type = "button";

              // Notes section (hidden by default, visible if there are notes)
              const notesSection = document.createElement("div");
              notesSection.className = hasNotes ? "notes-section visible" : "notes-section";

              const ta = document.createElement("textarea");
              ta.className = "p-notes-small";
              ta.placeholder = "Notes";
              ta.value = (p.notes || "");

              const saveBtn = document.createElement("button");
              saveBtn.textContent = "Save";
              saveBtn.type = "button";

              const status = document.createElement("span");
              status.className = "note-status";

              notesSection.appendChild(ta);
              notesSection.appendChild(saveBtn);
              notesSection.appendChild(status);

              // Toggle function for both buttons
              const toggleNotes = () => {
                const isVisible = notesSection.classList.toggle("visible");
                const btnText = isVisible ? "Hide Note" : (hasNotes ? "Edit Note" : "Add Note");
                addNoteBtn.textContent = btnText;
                addNoteBtnMobile.textContent = btnText;
                if (isVisible) {
                  ta.focus();
                }
              };

              addNoteBtn.addEventListener("click", toggleNotes);
              addNoteBtnMobile.addEventListener("click", toggleNotes);

              saveBtn.addEventListener("click", async () => {
                saveBtn.disabled = true;
                status.textContent = "Savingâ€¦";
                try {
                  const res = await fetch(`${BASE}/functions/v1/update-participant`, {
                    method: "POST",
                    headers: buildHeaders(),
                    body: JSON.stringify({ id: p.id, status: statusSel.value, notes: ta.value }),
                  });
                  const json = await res.json();
                  if (!res.ok || !json.ok) {
                    status.textContent = `Error: ${json.error || res.statusText}`;
                    return;
                  }
                  status.textContent = "Saved";
                  await fetchMatch();
                } catch (err) {
                  status.textContent = "Request failed";
                } finally {
                  saveBtn.disabled = false;
                }
              });

              right.appendChild(addNoteBtn);
              right.appendChild(notesSection);

              mainRow.appendChild(left);
              mainRow.appendChild(right);
              li.appendChild(mainRow);
              list.appendChild(li);
            }
          }
        }

        pForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = (pName.value || "").trim();
          const status = (pStatus.value || "not_invited").trim();
          const notes = (pNotes.value || "").trim();
          if (!name) { pMsg.textContent = "Name is required"; return; }
          pMsg.textContent = "Addingâ€¦";
          pForm.querySelector("button").disabled = true;

          try {
            const res = await fetch(`${BASE}/functions/v1/add-participant`, {
              method: "POST",
              headers: buildHeaders(),
              body: JSON.stringify({ match_id: UUID, name, status, notes }),
            });
            const json = await res.json();
            if (!res.ok || !json.ok) {
              pMsg.textContent = `Error: ${json.error || res.statusText}`;
              return;
            }
            pName.value = "";
            pStatus.value = "not_invited";
            pNotes.value = "";
            pMsg.textContent = "Added";
            await fetchMatch();
          } catch (err) {
            pMsg.textContent = "Request failed";
          } finally {
            pForm.querySelector("button").disabled = false;
          }
        });

        mSave.addEventListener("click", async () => {
          mSave.disabled = true;
          mNotesStatus.textContent = "Savingâ€¦";
          try {
            const res = await fetch(`${BASE}/functions/v1/update-match-notes`, {
              method: "POST",
              headers: buildHeaders(),
              body: JSON.stringify({ id: UUID, notes: mNotes.value || "" }),
            });
            const json = await res.json();
            if (!res.ok || !json.ok) {
              mNotesStatus.textContent = `Error: ${json.error || res.statusText}`;
              return;
            }
            mNotesStatus.textContent = "Saved";
            await fetchMatch();
          } catch (err) {
            mNotesStatus.textContent = "Request failed";
          } finally {
            mSave.disabled = false;
          }
        });

        // initial load
        renderMyMatches(UUID);
        fetchMatch();

        if (myMatchesClear) {
          myMatchesClear.addEventListener('click', () => {
            try { localStorage.removeItem(STORAGE_KEY); } catch (_) {}
            renderMyMatches(UUID);
          });
        }
      })();
    </script>
  </body>
</html>
