<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Padel Match Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { color-scheme: light dark; --bg:#0b0c10; --fg:#e5e7eb; --card:#111827; --muted:#9ca3af; }
      html, body { height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0c10; color:var(--fg); }
      .wrap { min-height:100%; display:grid; place-items:center; padding:24px; }
      .card { width:100%; max-width:820px; background: rgba(17,24,39,.9); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:24px; }
      h1 { margin:0 0 12px 0; font-size:24px; }
      h2 { margin:16px 0 8px; font-size:18px; }
      p { margin:0 0 12px 0; color:var(--muted); }
      .grid { display:grid; grid-template-columns: 140px 1fr; gap:6px 12px; }
      .label { color:var(--muted); }
      code { background: rgba(255,255,255,.06); padding:2px 6px; border-radius:6px; }
      ul { margin:8px 0 0 0; padding-left:18px; }
      li { margin:4px 0; }
      form.inline { display:flex; gap:8px; margin-top:8px; }
      input, select { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.05); color:var(--fg); }
      button { padding:8px 12px; border-radius:8px; background:#2563eb; color:white; border:none; cursor:pointer; }
      button:disabled { opacity:.6; cursor:not-allowed; }
      .muted { color:var(--muted); }
      a { color:#93c5fd; }
      .row { display:flex; gap:10px; align-items:center; }
      .sep { opacity:.35; }
      .error { color: #fecaca; }
      .warn { color: #fde68a; }
    </style>
    <script src="config.js" defer></script>
  </head>
  <body>
    <main class="wrap">
      <section class="card" role="region" aria-labelledby="title">
        <h1 id="title">Padel match</h1>
        <p id="desc">Loading…</p>

        <div id="details" style="display:none">
          <div class="grid" aria-describedby="desc">
            <div class="label">Title</div>
            <div id="m_title" class="row"></div>
            <div class="label">Status</div>
            <div id="m_status"></div>
            <div class="label">Created</div>
            <div id="m_created"></div>
            <div class="label">ID</div>
            <div><code id="m_id"></code></div>
          </div>

          <h2>Participants</h2>
          <ul id="participants"></ul>
          <form id="p_form" class="inline" autocomplete="off">
            <input id="p_name" name="name" placeholder="Participant name" required />
            <select id="p_status" name="status">
              <option value="invited" selected>invited</option>
              <option value="confirmed">confirmed</option>
              <option value="declined">declined</option>
            </select>
            <button id="p_add" type="submit">Add</button>
          </form>
          <div id="p_msg" class="muted" aria-live="polite"></div>
        </div>

        <p style="margin-top:16px"><a href="create.html">Create a new match</a></p>
      </section>
    </main>

    <script>
      (function () {
        const params = new URLSearchParams(location.search);
        const UUID = (params.get("id") || "").trim();

        const desc = document.getElementById("desc");
        const details = document.getElementById("details");
        const mTitle = document.getElementById("m_title");
        const mStatus = document.getElementById("m_status");
        const mCreated = document.getElementById("m_created");
        const mId = document.getElementById("m_id");
        const list = document.getElementById("participants");
        const pForm = document.getElementById("p_form");
        const pName = document.getElementById("p_name");
        const pStatus = document.getElementById("p_status");
        const pMsg = document.getElementById("p_msg");

        if (!UUID) {
          desc.textContent = "No match id provided. Use ?id=<uuid> or create a new match.";
          return;
        }

        const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
        const localBase = `${location.protocol}//${location.hostname}:54321`;
        const BASE = isLocal ? localBase : "https://epbxkcopfodxdseteqlh.functions.supabase.co";
        const anonKey = isLocal ?
              null :
              "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwYnhrY29wZm9keGRzZXRlcWxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODY0OTgsImV4cCI6MjA3Mzk2MjQ5OH0.JNifi9ckldkZi7eKJkCnPBtOPM1y5eLZTKJ19THY-YI"

        function buildHeaders() {
          const base = { "Content-Type": "application/json" };
          if (isLocal) return base;
          if (!anonKey) {
            // Show a warning and still try without headers
            const warn = document.createElement("div");
            warn.className = "warn";
            warn.textContent = "Missing anon key (config.js). Some actions may fail (401).";
            document.querySelector(".card").prepend(warn);
            return base;
          }
          return { ...base, apikey: anonKey, Authorization: `Bearer ${anonKey}` };
        }

        async function fetchMatch() {
          desc.textContent = "Loading…";
          details.style.display = "none";
          try {
            const res = await fetch(`${BASE}/functions/v1/get-match?id=${encodeURIComponent(UUID)}`, {
              headers: buildHeaders(),
            });
            const json = await res.json();
            if (!res.ok || !json.ok) {
              desc.textContent = `Error: ${json.error || res.statusText}`;
              return;
            }
            render(json.match);
          } catch (e) {
            desc.textContent = `Request failed`;
          }
        }

        function render(match) {
          document.title = `Padel Match • ${match.title}`;
          desc.textContent = `Match ${match.id}`;
          mTitle.textContent = match.title;
          mStatus.textContent = match.status;
          mCreated.textContent = new Date(match.created_at).toLocaleString();
          mId.textContent = match.id;
          details.style.display = "block";

          list.innerHTML = "";
          const participants = Array.isArray(match.match_participants) ? match.match_participants : [];
          if (participants.length === 0) {
            const li = document.createElement("li");
            li.className = "muted";
            li.textContent = "No participants yet";
            list.appendChild(li);
          } else {
            for (const p of participants) {
              const li = document.createElement("li");
              li.textContent = `${p.name} — ${p.status}`;
              list.appendChild(li);
            }
          }
        }

        pForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = (pName.value || "").trim();
          const status = (pStatus.value || "invited").trim();
          if (!name) { pMsg.textContent = "Name is required"; return; }
          pMsg.textContent = "Adding…";
          pForm.querySelector("button").disabled = true;

          try {
            const res = await fetch(`${BASE}/functions/v1/add-participant`, {
              method: "POST",
              headers: buildHeaders(),
              body: JSON.stringify({ match_id: UUID, name, status }),
            });
            const json = await res.json();
            if (!res.ok || !json.ok) {
              pMsg.textContent = `Error: ${json.error || res.statusText}`;
              return;
            }
            pName.value = "";
            pStatus.value = "invited";
            pMsg.textContent = "Added";
            await fetchMatch();
          } catch (err) {
            pMsg.textContent = "Request failed";
          } finally {
            pForm.querySelector("button").disabled = false;
          }
        });

        fetchMatch();
      })();
    </script>
  </body>
</html>
