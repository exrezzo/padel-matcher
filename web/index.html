<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Padel Match Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { color-scheme: light dark; --bg:#0b0c10; --fg:#e5e7eb; --card:#111827; --muted:#9ca3af; }
      html, body { height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0c10; color:var(--fg); }
      .wrap { min-height:100%; display:grid; place-items:center; padding:24px; }
      .card { width:100%; max-width:900px; background: rgba(17,24,39,.9); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:24px; }
      h1 { margin:0 0 12px 0; font-size:24px; }
      h2 { margin:16px 0 8px; font-size:18px; }
      p { margin:0 0 12px 0; color:var(--muted); }
      .grid { display:grid; grid-template-columns: 140px 1fr; gap:6px 12px; }
      .label { color:var(--muted); }
      code { background: rgba(255,255,255,.06); padding:2px 6px; border-radius:6px; }
      ul { margin:8px 0 0 0; padding-left:18px; }
      li { margin:8px 0; }
      form.inline { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
      input, select, textarea { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.05); color:var(--fg); }
      textarea { width:100%; min-height:60px; resize: vertical; }
      button { padding:8px 12px; border-radius:8px; background:#2563eb; color:white; border:none; cursor:pointer; }
      button:disabled { opacity:.6; cursor:not-allowed; }
      .muted { color:var(--muted); }
      a { color:#93c5fd; }
      .row { display:flex; gap:10px; align-items:center; }
      .sep { opacity:.35; }
      .error { color: #fecaca; }
      .warn { color: #fde68a; }
      .note-status { font-size:12px; color:var(--muted); }
      .p-inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      .p-inline > * { flex: 0 0 auto; }
      .p-notes-input { flex: 1 1 100%; }
      /* New layout for participant item */
      .p-row { display:flex; gap:12px; align-items:flex-start; }
      .p-left { flex: 1 1 auto; display:flex; gap:10px; align-items:center; }
      .p-right { flex: 0 0 280px; display:flex; gap:8px; align-items:flex-start; }
      .p-notes-small { width: 200px; height: 48px; resize: vertical; min-height: 40px; }
      .status { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid transparent; text-transform: lowercase; }
      .s-invited { background:#f59e0b1a; color:#fbbf24; border-color:#f59e0b55; }
      .s-confirmed { background:#10b9811a; color:#34d399; border-color:#10b98155; }
      .s-declined { background:#ef44441a; color:#f87171; border-color:#ef444455; }
      .status-select { padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color:var(--fg); }
      /* Counter badge styles */
      .count { margin: 4px 0 8px 0; }
      .count-badge { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid transparent; margin-left:6px; }
      .c-need { background:#f59e0b1a; color:#fbbf24; border-color:#f59e0b55; }
      .c-full { background:#10b9811a; color:#34d399; border-color:#10b98155; }
      .c-over { background:#6366f11a; color:#a5b4fc; border-color:#6366f155; }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="card" role="region" aria-labelledby="title">
        <h1 id="title">Padel match</h1>
        <p id="desc">Loading…</p>

        <div id="details" style="display:none">
          <div class="grid" aria-describedby="desc">
            <div class="label">Title</div>
            <div id="m_title" class="row"></div>
            <div class="label">Status</div>
            <div id="m_status"></div>
            <div class="label">Created</div>
            <div id="m_created"></div>
            <div class="label">ID</div>
            <div><code id="m_id"></code></div>
          </div>

          <h2>Match notes</h2>
          <div class="row" style="align-items:flex-start; gap:8px;">
            <textarea id="m_notes" style="flex:1; min-height:80px; width:100%;"></textarea>
            <div style="display:flex; flex-direction:column; gap:6px;">
              <button id="m_save">Save</button>
              <span id="m_notes_status" class="note-status"></span>
            </div>
          </div>

          <h2>Participants</h2>
          <div id="count" class="count"></div>
          <ul id="participants"></ul>
          <form id="p_form" class="inline" autocomplete="off">
            <div class="p-inline">
              <input id="p_name" name="name" placeholder="Participant name" required />
              <select id="p_status" name="status">
                <option value="invited" selected>invited</option>
                <option value="confirmed">confirmed</option>
                <option value="declined">declined</option>
              </select>
              <button id="p_add" type="submit">Add</button>
            </div>
            <textarea id="p_notes" class="p-notes-input" name="notes" placeholder="Notes (optional)"></textarea>
          </form>
          <div id="p_msg" class="muted" aria-live="polite"></div>
        </div>

        <p style="margin-top:16px"><a href="create.html">Create a new match</a></p>
      </section>
    </main>

    <script>
      (function () {
        const params = new URLSearchParams(location.search);
        const UUID = (params.get("id") || "").trim();

        const desc = document.getElementById("desc");
        const details = document.getElementById("details");
        const mTitle = document.getElementById("m_title");
        const mStatus = document.getElementById("m_status");
        const mCreated = document.getElementById("m_created");
        const mId = document.getElementById("m_id");
        const list = document.getElementById("participants");
        const pForm = document.getElementById("p_form");
        const pName = document.getElementById("p_name");
        const pStatus = document.getElementById("p_status");
        const pNotes = document.getElementById("p_notes");
        const pMsg = document.getElementById("p_msg");
        const countEl = document.getElementById("count");
        const mNotes = document.getElementById("m_notes");
        const mSave = document.getElementById("m_save");
        const mNotesStatus = document.getElementById("m_notes_status");

        if (!UUID) {
          desc.textContent = "No match id provided. Use ?id=<uuid> or create a new match.";
          return;
        }

        const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
        const localBase = `${location.protocol}//${location.hostname}:54321`;
        const BASE = isLocal ? localBase : "https://epbxkcopfodxdseteqlh.functions.supabase.co";
        const anonKey = isLocal ? null : "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwYnhrY29wZm9keGRzZXRlcWxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODY0OTgsImV4cCI6MjA3Mzk2MjQ5OH0.JNifi9ckldkZi7eKJkCnPBtOPM1y5eLZTKJ19THY-YI";

        function buildHeaders() {
          const base = { "Content-Type": "application/json" };
          if (isLocal) return base;
          if (!anonKey) {
            const warn = document.createElement("div");
            warn.className = "warn";
            warn.textContent = "Missing anon key. Some actions may fail (401).";
            document.querySelector(".card").prepend(warn);
            return base;
          }
          return { ...base, apikey: anonKey, Authorization: `Bearer ${anonKey}` };
        }

        async function fetchMatch() {
          desc.textContent = "Loading…";
          details.style.display = "none";
          try {
            const res = await fetch(`${BASE}/functions/v1/get-match?id=${encodeURIComponent(UUID)}`, {
              headers: buildHeaders(),
            });
            const json = await res.json();
            if (!res.ok || !json.ok) {
              desc.textContent = `Error: ${json.error || res.statusText}`;
              return;
            }
            render(json.match);
          } catch (e) {
            desc.textContent = `Request failed`;
          }
        }

        function render(match) {
          document.title = `Padel Match • ${match.title}`;
          desc.textContent = `Match ${match.id}`;
          mTitle.textContent = match.title;
          mStatus.textContent = match.status;
          mCreated.textContent = new Date(match.created_at).toLocaleString();
          mId.textContent = match.id;
          details.style.display = "block";
          if (mNotes) mNotes.value = match.notes || "";

          list.innerHTML = "";
          const participants = Array.isArray(match.match_participants) ? match.match_participants : [];

          // Update counter (target 4)
          const TARGET = 4;
          const confirmedCount = participants.filter((p) => String(p.status || '').toLowerCase() === 'confirmed').length;
          const remaining = Math.max(0, TARGET - confirmedCount);
          let cls = confirmedCount === TARGET ? 'c-full' : (confirmedCount < TARGET ? 'c-need' : 'c-over');
          if (countEl) {
            countEl.innerHTML = `Confirmed: <span class="count-badge ${cls}">${confirmedCount}/${TARGET}</span> ${confirmedCount < TARGET ? `(${remaining} needed)` : confirmedCount > TARGET ? `(over by ${confirmedCount - TARGET})` : '(full)'}`;
          }

          if (participants.length === 0) {
            const li = document.createElement("li");
            li.className = "muted";
            li.textContent = "No participants yet";
            list.appendChild(li);
          } else {
            for (const p of participants) {
              // Build a horizontal row with left (name + status) and right (notes + save)
              const li = document.createElement("li");
              const row = document.createElement("div");
              row.className = "p-row";

              const left = document.createElement("div");
              left.className = "p-left";
              const nameEl = document.createElement("strong");
              nameEl.textContent = p.name;
              const st = document.createElement("span");
              const s = String(p.status || "invited").toLowerCase();
              const sClass = s === "confirmed" ? "s-confirmed" : s === "declined" ? "s-declined" : "s-invited";
              st.className = `status ${sClass}`;
              st.textContent = s;
              left.appendChild(nameEl);
              left.appendChild(st);

              // Editable status dropdown
              const statusSel = document.createElement("select");
              statusSel.className = "status-select";
              for (const opt of ["invited","confirmed","declined"]) {
                const o = document.createElement("option");
                o.value = opt; o.textContent = opt; if (opt === s) o.selected = true; statusSel.appendChild(o);
              }
              statusSel.addEventListener("change", () => {
                const val = statusSel.value;
                st.className = `status ${val === "confirmed" ? "s-confirmed" : val === "declined" ? "s-declined" : "s-invited"}`;
                st.textContent = val;
              });
              left.appendChild(statusSel);

              const right = document.createElement("div");
              right.className = "p-right";
              const ta = document.createElement("textarea");
              ta.className = "p-notes-small";
              ta.placeholder = "Notes";
              ta.value = (p.notes || "");
              const saveBtn = document.createElement("button");
              saveBtn.textContent = "Save";
              const status = document.createElement("span");
              status.className = "note-status";

              saveBtn.addEventListener("click", async () => {
                saveBtn.disabled = true;
                status.textContent = "Saving…";
                try {
                  const res = await fetch(`${BASE}/functions/v1/update-participant`, {
                    method: "POST",
                    headers: buildHeaders(),
                    body: JSON.stringify({ id: p.id, status: statusSel.value, notes: ta.value }),
                  });
                  const json = await res.json();
                  if (!res.ok || !json.ok) {
                    status.textContent = `Error: ${json.error || res.statusText}`;
                    return;
                  }
                  status.textContent = "Saved";
                  await fetchMatch();
                } catch (err) {
                  status.textContent = "Request failed";
                } finally {
                  saveBtn.disabled = false;
                }
              });

              right.appendChild(ta);
              right.appendChild(saveBtn);
              right.appendChild(status);

              row.appendChild(left);
              row.appendChild(right);
              li.appendChild(row);
              list.appendChild(li);
            }
          }
        }

        pForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = (pName.value || "").trim();
          const status = (pStatus.value || "invited").trim();
          const notes = (pNotes.value || "").trim();
          if (!name) { pMsg.textContent = "Name is required"; return; }
          pMsg.textContent = "Adding…";
          pForm.querySelector("button").disabled = true;

          try {
            const res = await fetch(`${BASE}/functions/v1/add-participant`, {
              method: "POST",
              headers: buildHeaders(),
              body: JSON.stringify({ match_id: UUID, name, status, notes }),
            });
            const json = await res.json();
            if (!res.ok || !json.ok) {
              pMsg.textContent = `Error: ${json.error || res.statusText}`;
              return;
            }
            pName.value = "";
            pStatus.value = "invited";
            pNotes.value = "";
            pMsg.textContent = "Added";
            await fetchMatch();
          } catch (err) {
            pMsg.textContent = "Request failed";
          } finally {
            pForm.querySelector("button").disabled = false;
          }
        });

        mSave.addEventListener("click", async () => {
          mSave.disabled = true;
          mNotesStatus.textContent = "Saving…";
          try {
            const res = await fetch(`${BASE}/functions/v1/update-match-notes`, {
              method: "POST",
              headers: buildHeaders(),
              body: JSON.stringify({ id: UUID, notes: mNotes.value || "" }),
            });
            const json = await res.json();
            if (!res.ok || !json.ok) {
              mNotesStatus.textContent = `Error: ${json.error || res.statusText}`;
              return;
            }
            mNotesStatus.textContent = "Saved";
            await fetchMatch();
          } catch (err) {
            mNotesStatus.textContent = "Request failed";
          } finally {
            mSave.disabled = false;
          }
        });

        fetchMatch();
      })();
    </script>
  </body>
</html>
